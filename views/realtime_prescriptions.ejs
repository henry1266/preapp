<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/dashboard.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    h1 {
      color: #0056b3;
      text-align: center;
    }
    .container {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    #leftColumn {
      flex: 1;
      background-color: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #rightColumn {
      flex: 1;
      background-color: #ffffff80;
      padding: 10px;
      border-radius: 8px;
      border: 2px dashed #ccc;
      color: #333;
    }
    .prescription-info p {
      margin: 8px 0;
      font-size: 1rem;
    }
    .prescription-info strong {
      color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #e9ecef;
      color: #495057;
    }
    .no-data {
      color: #777;
      text-align: center;
      font-size: 1.1em;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1><%= title %></h1>

  <div class="container">
    <div id="leftColumn">
      <div id="prescriptionDetailsContainer">
        <p class="no-data">等待處方資料更新...</p>
      </div>
    </div>
    <div id="rightColumn">
      <div id="rightInfoBox">
        <p class="no-data">尚無處方資訊</p>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const prescriptionDetailsContainer = document.getElementById('prescriptionDetailsContainer');
    const rightInfoBox = document.getElementById('rightInfoBox');

    function renderPrescription(prescription) {
      prescriptionDetailsContainer.innerHTML = '';
      rightInfoBox.innerHTML = '';

      if (!prescription || Object.keys(prescription).length === 0) {
        prescriptionDetailsContainer.innerHTML = '<p class="no-data">等待處方資料更新...</p>';
        rightInfoBox.innerHTML = '<p class="no-data">尚無處方資訊</p>';
        return;
      }

      // 左側基本資訊 + 藥品表格
      const infoDiv = document.createElement('div');
      infoDiv.classList.add('prescription-info');

      let content = '';
      content += `<p><strong>病患姓名:</strong> ${prescription.patientName || prescription.name || 'N/A'}`;
      content += `<strong>   日期:</strong> ${prescription.date ? new Date(prescription.date).toLocaleString() : 'N/A'}</p>`;
      if (prescription.status) content += `<p><strong>狀態:</strong> ${prescription.status}</p>`;
      infoDiv.innerHTML = content;
      prescriptionDetailsContainer.appendChild(infoDiv);

      // 藥品表格
      if (prescription.medications && Array.isArray(prescription.medications) && prescription.medications.length > 0) {
        const table = document.createElement('table');
        const thead = document.createElement('thead');        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        ['藥品名稱', '健保碼',  '頻率', '數量'].forEach(text => { // Added frequency to header
          const th = document.createElement('th');
          th.textContent = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);     prescription.medications.forEach(med => {
          const row = document.createElement('tr');
          const name = med.dname || 'N/A';
          const code = med.dinsuranceCode || 'N/A';
          const frequency = med.frequency || 'N/A'; // Added frequency data
          const quantity = med.dcount || 0;
          

          [name, code,  frequency , quantity].forEach(text => { // Added frequency to row data
            const td = document.createElement('td');
            td.textContent = text;
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        prescriptionDetailsContainer.appendChild(table);
      } else {
        const noMedsP = document.createElement('p');
        noMedsP.textContent = '無藥品資訊。';
        prescriptionDetailsContainer.appendChild(noMedsP);
      }

      // 右側顯示「處方 ID」與「詳情」
      let rightContent = '';
      if (prescription.plusday && prescription.plusday !== 0) {
  const plusdayDisplay = `+++${prescription.plusday}天+++`;
  rightContent += `<p><strong style="color: red;">特殊註記 :</strong> ${plusdayDisplay}</p>`;
}
      rightContent += `<p><strong>處方 ID:</strong> ${prescription._id || 'N/A'}</p>`;
      if (prescription.details) rightContent += `<p><strong>詳情:</strong> ${prescription.details}</p>`;
      rightInfoBox.innerHTML = rightContent;
    }

    socket.on('connect', () => {
      console.log('Connected to Socket.IO server!');
    });

    socket.on('initial_prescriptions', (initialDataArray) => {
      console.log('Received initial prescriptions:', initialDataArray);
      if (initialDataArray && initialDataArray.length > 0) {
        const latestInitial = initialDataArray.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))[0];
        renderPrescription(latestInitial);
      } else {
        prescriptionDetailsContainer.innerHTML = '<p class="no-data">目前無處方資料。</p>';
        rightInfoBox.innerHTML = '<p class="no-data">尚無處方資訊</p>';
      }
    });

    socket.on('prescription_update', (newPrescription) => {
      console.log('Received prescription update:', newPrescription);
      renderPrescription(newPrescription);
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from Socket.IO server.');
    });
  </script>
</body>
</html>
